# app.py â€” DRT: ìŠ¹Â·í•˜ì°¨ ì„ íƒ â†’ ìµœì  ê²½ë¡œ(ì‹œê°„/ê±°ë¦¬) + ì§€ë„ë§Œ í‘œì¶œ
import os
import requests
import streamlit as st
import geopandas as gpd
import pandas as pd
import folium
from shapely.geometry import LineString, MultiLineString
from streamlit_folium import st_folium

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ì„¤ì • (í† í°ì€ Streamlit Secretsì— ë‘ëŠ” ê±¸ ê¶Œì¥)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MAPBOX_TOKEN = st.secrets.get("MAPBOX_TOKEN", "").strip() or "YOUR_MAPBOX_TOKEN"

st.set_page_config(page_title="ì²œì•ˆ DRT â€“ ê²½ë¡œ ìµœì í™”", layout="wide")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ìœ í‹¸
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
def to_wgs84(gdf: gpd.GeoDataFrame) -> gpd.GeoDataFrame:
    try:
        if gdf.crs is None:
            return gdf.set_crs(epsg=4326)
        return gdf.to_crs(epsg=4326)
    except Exception:
        return gdf

def to_linestring(geom):
    """MultiLineStringì´ë©´ ê°€ì¥ ê¸´ ì„ ë§Œ ì¶”ì¶œ"""
    if isinstance(geom, MultiLineString):
        geom = max(list(geom.geoms), key=lambda L: L.length)
    return geom if isinstance(geom, LineString) else None

def build_stops_from_route(route_gdf: gpd.GeoDataFrame, route_name: str) -> pd.DataFrame:
    """ë…¸ì„  ë¼ì¸ì˜ ëª¨ë“  ê¼­ì§“ì ì„ 'ì •ë¥˜ì¥'ì²˜ëŸ¼ ì‚¬ìš©"""
    geom = to_linestring(route_gdf.geometry.iloc[0])
    if geom is None:
        return pd.DataFrame(columns=["name", "lon", "lat"])
    coords = list(geom.coords)                     # [(lon,lat),...]
    rows = [{"name": f"{route_name} {i+1}ë²ˆ ì •ë¥˜ì¥", "lon": x, "lat": y} for i, (x, y) in enumerate(coords)]
    return pd.DataFrame(rows)

def mapbox_route(p, q, profile="driving"):
    """p/q=(lon,lat) â†’ Mapbox Directions ìš”ì²­. ì‹¤íŒ¨ ì‹œ None ë°˜í™˜"""
    if not MAPBOX_TOKEN or MAPBOX_TOKEN.startswith("YOUR_"):
        return None
    url = f"https://api.mapbox.com/directions/v5/mapbox/{profile}/{p[0]},{p[1]};{q[0]},{q[1]}"
    params = {"geometries": "geojson", "overview": "full", "access_token": MAPBOX_TOKEN}
    try:
        r = requests.get(url, params=params, timeout=12)
        r.raise_for_status()
        data = r.json()
        if not data.get("routes"):
            return None
        route = data["routes"][0]
        return {
            "coords": route["geometry"]["coordinates"],   # [[lon,lat],...]
            "distance_m": route.get("distance", 0.0),
            "duration_s": route.get("duration", 0.0),
        }
    except Exception:
        return None

def fallback_line(p, q, speed_kmh=30.0):
    """Mapbox ì‹¤íŒ¨ ì‹œ ì§ì„  ê²½ë¡œ + ë‹¨ìˆœ ì‹œê°„ ì¶”ì •"""
    from math import radians, sin, cos, asin, sqrt
    R = 6371000.0
    lon1, lat1, lon2, lat2 = map(radians, [p[0], p[1], q[0], q[1]])
    dlon, dlat = lon2 - lon1, lat2 - lat1
    h = sin(dlat/2)**2 + cos(lat1)*cos(lat2)*sin(dlon/2)**2
    dist_m = 2*R*asin(sqrt(h))
    dura_s = (dist_m/1000.0)/speed_kmh*3600.0
    return {"coords": [list(p), list(q)], "distance_m": dist_m, "duration_s": dura_s}

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë°ì´í„° ë¡œë“œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@st.cache_data
def load_routes():
    routes = {}
    for i in range(1, 5):
        shp = f"./drt_{i}.shp"
        if os.path.exists(shp):
            gdf = to_wgs84(gpd.read_file(shp))
            routes[f"DRT-{i}í˜¸ì„ "] = gdf
    return routes

ROUTES = load_routes()
if not ROUTES:
    st.error("drt_1~4.shp ì¤‘ ìµœì†Œ 1ê°œëŠ” ë ˆí¬ ë£¨íŠ¸ì— ìˆì–´ì•¼ í•©ë‹ˆë‹¤.")
    st.stop()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# UI â€” ì™¼ìª½: ì…ë ¥ / ì˜¤ë¥¸ìª½: ê²°ê³¼
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
left, right = st.columns([1.1, 2.4], gap="large")

with left:
    st.subheader("ğŸšŒ ìŠ¹Â·í•˜ì°¨ ì„¤ì •")
    route_name = st.selectbox("ìš´í–‰ ë…¸ì„ ", list(ROUTES.keys()))
    stops_df = build_stops_from_route(ROUTES[route_name], route_name)
    if stops_df.empty:
        st.error("ë…¸ì„  ë¼ì¸ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.")
        st.stop()

    start_name = st.selectbox("ì¶œë°œ ì •ë¥˜ì¥", stops_df["name"])
    end_name   = st.selectbox("ë„ì°© ì •ë¥˜ì¥", [n for n in stops_df["name"] if n != start_name])
    go = st.button("ê²½ë¡œ ìµœì í™” ë° ê³„ì‚°")

# ê²°ê³¼ ìƒíƒœ
if "result" not in st.session_state:
    st.session_state.result = None

if go:
    # ì„ íƒí•œ ì¢Œí‘œ
    srow = stops_df[stops_df["name"] == start_name].iloc[0]
    erow = stops_df[stops_df["name"] == end_name].iloc[0]
    p = (float(srow["lon"]), float(srow["lat"]))
    q = (float(erow["lon"]), float(erow["lat"]))

    res = mapbox_route(p, q, profile="driving")
    if res is None:
        res = fallback_line(p, q, speed_kmh=30.0)

    st.session_state.result = {
        "order": [start_name, end_name],
        "poly": res["coords"],          # [[lon,lat],...]
        "km":   res["distance_m"]/1000.0,
        "min":  res["duration_s"]/60.0,
        "start": (p[1], p[0]),          # (lat,lon)
        "end":   (q[1], q[0]),
        "route_name": route_name,
    }

with right:
    st.subheader("ğŸ“Š ê²°ê³¼")
    res = st.session_state.result
    if res:
        c1, c2, c3 = st.columns([1,1,2])
        with c1: st.metric("ğŸ“ ê±°ë¦¬", f"{res['km']:.2f} km")
        with c2: st.metric("â± ì†Œìš”ì‹œê°„", f"{res['min']:.1f} ë¶„")
        with c3: st.write(f"**ìš´í–‰ ìˆœì„œ:** {res['order'][0]} â†’ {res['order'][1]}")

        # ì§€ë„
        center = ((res["start"][0]+res["end"][0])/2, (res["start"][1]+res["end"][1])/2)
        m = folium.Map(location=center, zoom_start=13, tiles="CartoDB Positron")

        # ì„ íƒ ë…¸ì„  ë¼ì¸(ì›ë³¸ shp ë¼ì¸, ì°¸ê³ ìš©)
        geom = to_linestring(ROUTES[res["route_name"]].geometry.iloc[0])
        if geom is not None:
            folium.PolyLine([(lat, lon) for lon, lat in list(geom.coords)],
                            color="#9aa0a6", weight=4, opacity=0.4,
                            tooltip=f"{res['route_name']} (ì›ë³¸)").add_to(m)

        # ìµœì  ê²½ë¡œ(ì‹¤ì œ ìš´í–‰ ê²½ë¡œ)
        folium.PolyLine([(lat, lon) for lon, lat in res["poly"]],
                        color="#2b7de9", weight=6, opacity=0.9,
                        tooltip="ìµœì  ê²½ë¡œ").add_to(m)

        # ì¶œë°œ/ë„ì°© ë§ˆì»¤
        folium.Marker(res["start"], tooltip=res["order"][0],
                      icon=folium.Icon(color="green", icon="play")).add_to(m)
        folium.Marker(res["end"], tooltip=res["order"][1],
                      icon=folium.Icon(color="red", icon="stop")).add_to(m)

        st_folium(m, height=540, use_container_width=True)
    else:
        st.info("ì™¼ìª½ì—ì„œ ìŠ¹Â·í•˜ì°¨ë¥¼ ì„ íƒí•˜ê³  **ê²½ë¡œ ìµœì í™” ë° ê³„ì‚°**ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.")
